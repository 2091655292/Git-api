name: Append Sync Config

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      target_file:
        description: 'ç›®æ ‡å·¥ä½œæµæ–‡ä»¶è·¯å¾„'
        required: true
        default: '.github/workflows/sync.yml'
        type: string
      source_repo:
        description: 'æºä»“åº“ (æ ¼å¼: ç”¨æˆ·å/ä»“åº“å)'
        required: true
        default: ''
        type: string
      source_branch:
        description: 'æºåˆ†æ”¯'
        required: true
        default: 'main'
        type: string
      source_path:
        description: 'æºè·¯å¾„ (æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹)'
        required: true
        default: ''
        type: string
      dest_path:
        description: 'ç›®æ ‡è·¯å¾„ (æœ¬ä»“åº“ä½ç½®)'
        required: true
        default: ''
        type: string

jobs:
  append-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ PAT_TOKEN è·å–ä¿®æ”¹ workflow çš„æƒé™
          token: ${{ secrets.PAT_TOKEN }}

      - name: Append and Update Config
        env:
          TARGET_FILE: ${{ inputs.target_file }}
          # è·å–å››ä¸ªç‹¬ç«‹çš„è¾“å…¥å‚æ•°
          INPUT_REPO: ${{ inputs.source_repo }}
          INPUT_BRANCH: ${{ inputs.source_branch }}
          INPUT_SRC_PATH: ${{ inputs.source_path }}
          INPUT_DEST_PATH: ${{ inputs.dest_path }}
        run: |
          if [ ! -f "$TARGET_FILE" ]; then
            echo "::error:: æ–‡ä»¶ $TARGET_FILE ä¸å­˜åœ¨ï¼"
            exit 1
          fi

          echo "â–¶ æ­£åœ¨è¯»å–å¹¶åˆå¹¶é…ç½®..."

          python3 << 'EOF'
          import os
          import re
          import json
          import sys

          file_path = os.environ.get('TARGET_FILE')

          # 1. ä»ç¯å¢ƒå˜é‡è·å–è¾“å…¥
          repo = os.environ.get('INPUT_REPO', '').strip()
          branch = os.environ.get('INPUT_BRANCH', 'main').strip()
          src_path = os.environ.get('INPUT_SRC_PATH', '').strip()
          dest_path = os.environ.get('INPUT_DEST_PATH', '').strip()

          # 2. æ ¡éªŒè¾“å…¥
          if not repo or not src_path or not dest_path:
              print("::error:: é”™è¯¯ï¼šæºä»“åº“ã€æºè·¯å¾„å’Œç›®æ ‡è·¯å¾„ä¸èƒ½ä¸ºç©ºï¼")
              sys.exit(1)

          # 3. æ„é€ æ–°çš„ JSON å¯¹è±¡
          new_item = {
              "source_repo": repo,
              "source_branch": branch,
              "source_path": src_path,
              "dest_path": dest_path
          }
          
          # æ”¾å…¥åˆ—è¡¨ä¸­ï¼Œæ–¹ä¾¿åç»­ç»Ÿä¸€å¤„ç†
          new_items = [new_item]
          print(f"ğŸ“ å‡†å¤‡è¿½åŠ çš„é…ç½®: {json.dumps(new_item, ensure_ascii=False)}")

          # 4. è¯»å–åŸæ–‡ä»¶
          with open(file_path, 'r', encoding='utf-8') as f:
              content = f.read()

          # 5. æ­£åˆ™åŒ¹é…é…ç½®åŒºåŸŸ
          pattern = r"(# === SYNC_CONFIG_START ===\s*SYNC_TASKS=')(.*?)('\s*# === SYNC_CONFIG_END ===)"
          match = re.search(pattern, content, re.DOTALL)

          if not match:
              print("::error:: æœªæ‰¾åˆ°é…ç½®æ ‡è®°ã€‚è¯·æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦åŒ…å«æ ‡è®°ã€‚")
              sys.exit(1)

          # 6. è§£ææ—§é…ç½®
          old_json_str = match.group(2).strip()
          try:
              if old_json_str:
                  current_list = json.loads(old_json_str)
              else:
                  current_list = []
          except json.JSONDecodeError:
              print(f"::error:: åŸæœ‰é…ç½® JSON æ ¼å¼é”™è¯¯: {old_json_str}")
              sys.exit(1)

          # 7. åˆå¹¶é…ç½®
          merged_list = current_list + new_items

          # 8. æ ¼å¼åŒ–å¹¶ä¿æŒç¼©è¿›
          merged_json_str = json.dumps(merged_list, indent=2, ensure_ascii=False)
          
          # æ™ºèƒ½è·å–ç¼©è¿›
          prefix_line = match.group(1)
          indent_match = re.search(r"\n([ \t]*)SYNC_TASKS=", prefix_line)
          base_indent = indent_match.group(1) if indent_match else "          "

          # ç»™ JSON æ¯ä¸€è¡Œæ·»åŠ ç¼©è¿›
          json_lines = merged_json_str.split('\n')
          formatted_json = json_lines[0] + "\n" + "\n".join([base_indent + line for line in json_lines[1:]])

          # 9. æ›¿æ¢å¹¶å†™å›
          new_block = f"{match.group(1)}{formatted_json}{match.group(3)}"
          new_content = content[:match.start()] + new_block + content[match.end():]

          with open(file_path, 'w', encoding='utf-8') as f:
              f.write(new_content)

          print(f"âœ… é…ç½®å·²æ›´æ–°ã€‚åŸä»»åŠ¡æ•°: {len(current_list)}ï¼Œæ–°å¢: 1ï¼Œæ€»æ•°: {len(merged_list)}")
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TARGET_FILE="${{ inputs.target_file }}"
          
          if git diff --quiet "$TARGET_FILE"; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
            exit 0
          fi
          
          git add "$TARGET_FILE"
          git commit -m "chore: append new sync task configuration"
          git push
          echo "ğŸš€ æ–°é…ç½®å·²è¿½åŠ å¹¶æäº¤ã€‚"