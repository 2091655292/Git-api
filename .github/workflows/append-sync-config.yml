name: Append Sync Config

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      target_file:
        description: 'ç›®æ ‡å·¥ä½œæµæ–‡ä»¶è·¯å¾„ (ä¾‹å¦‚: .github/workflows/sync.yml)'
        required: true
        default: '.github/workflows/sync.yml'
        type: string
      new_task:
        description: 'è¦æ–°å¢çš„ä»»åŠ¡ (æ”¯æŒ JSON å¯¹è±¡æˆ–æ•°ç»„)'
        required: true
        type: string

jobs:
  append-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Append and Update Config
        env:
          # å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œä¾›ä¸‹é¢çš„ Python è„šæœ¬ç›´æ¥è¯»å–
          TARGET_FILE: ${{ inputs.target_file }}
          NEW_TASK_INPUT: ${{ inputs.new_task }}
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$TARGET_FILE" ]; then
            echo "::error:: æ–‡ä»¶ $TARGET_FILE ä¸å­˜åœ¨ï¼"
            exit 1
          fi

          echo "â–¶ æ­£åœ¨è¯»å–å¹¶åˆå¹¶é…ç½®..."

          # ä½¿ç”¨ Python å¤„ç† JSON åˆå¹¶ä¸æ ¼å¼åŒ–
          # æ³¨æ„ï¼špython3 << 'EOF' ... EOF æ˜¯æ ‡å‡†å†™æ³•ï¼Œè„šæœ¬å†…ç›´æ¥ä½¿ç”¨ os.environ è¯»å–å˜é‡
          python3 << 'EOF'
          import os
          import re
          import json
          import sys

          # ä»ç¯å¢ƒå˜é‡è·å–é…ç½®
          file_path = os.environ.get('TARGET_FILE')
          new_input = os.environ.get('NEW_TASK_INPUT')

          # 1. è¯»å–æ–‡ä»¶å†…å®¹
          with open(file_path, 'r', encoding='utf-8') as f:
              content = f.read()

          # 2. æå–æ ‡è®°ä¸­é—´çš„å†…å®¹
          # æ­£åˆ™åŒ¹é…ï¼šSTARTæ ‡è®° -> ä¸­é—´å†…å®¹ -> ENDæ ‡è®°
          pattern = r"(# === SYNC_CONFIG_START ===\s*SYNC_TASKS=')(.*?)(' \s*# === SYNC_CONFIG_END ===)"
          match = re.search(pattern, content, re.DOTALL)

          if not match:
              print("::error:: æœªæ‰¾åˆ°é…ç½®æ ‡è®°ã€‚è¯·ç¡®ä¿ç›®æ ‡æ–‡ä»¶åŒ…å« # === SYNC_CONFIG_START === å’Œ END æ ‡è®°ã€‚")
              sys.exit(1)

          # 3. è§£ææ—§é…ç½®
          old_json_str = match.group(2).strip()
          try:
              # å¦‚æœåŸé…ç½®ä¸ºç©ºæˆ–æ— æ•ˆï¼Œåˆå§‹åŒ–ä¸ºç©ºåˆ—è¡¨
              if old_json_str:
                  current_list = json.loads(old_json_str)
              else:
                  current_list = []
          except json.JSONDecodeError:
              print("::error:: åŸæœ‰é…ç½® JSON æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£æã€‚")
              sys.exit(1)

          # 4. è§£ææ–°è¾“å…¥
          try:
              new_data = json.loads(new_input)
              # å¦‚æœè¾“å…¥çš„æ˜¯å•ä¸ªå¯¹è±¡ï¼Œè½¬ä¸ºåˆ—è¡¨
              if isinstance(new_data, dict):
                  new_items = [new_data]
              else:
                  new_items = new_data
          except json.JSONDecodeError:
              print("::error:: è¾“å…¥çš„æ–°é…ç½® JSON æ ¼å¼é”™è¯¯ã€‚")
              sys.exit(1)

          # 5. åˆå¹¶é…ç½® (æ—§ + æ–°)
          merged_list = current_list + new_items

          # 6. æ ¼å¼åŒ–æ–° JSON
          # ç”Ÿæˆç¼©è¿›æ ¼å¼ï¼Œå¹¶è®¡ç®—åŸæœ‰ç¼©è¿›ä»¥ä¿æŒä»£ç æ•´æ´
          merged_json_str = json.dumps(merged_list, indent=2, ensure_ascii=False)
          
          # è®¡ç®—ç¼©è¿› (ä¸ºäº†ç¾è§‚)
          prefix_line = match.group(1)
          indent_match = re.search(r"\n([ \t]*)", prefix_line)
          base_indent = indent_match.group(1) if indent_match else "          "

          # ç»™ JSON æ¯ä¸€è¡Œæ·»åŠ ç¼©è¿›ï¼ˆç¬¬ä¸€è¡Œé™¤å¤–ï¼‰
          json_lines = merged_json_str.split('\n')
          formatted_json = json_lines[0] + "\n" + "\n".join([base_indent + line for line in json_lines[1:]])

          # 7. æ›¿æ¢å†…å®¹
          new_block = f"{match.group(1)}{formatted_json}{match.group(3)}"
          new_content = content[:match.start()] + new_block + content[match.end():]

          # 8. å†™å›æ–‡ä»¶
          with open(file_path, 'w', encoding='utf-8') as f:
              f.write(new_content)

          print(f"âœ… é…ç½®å·²æ›´æ–°ã€‚åŸä»»åŠ¡æ•°: {len(current_list)}ï¼Œæ–°å¢: {len(new_items)}ï¼Œæ€»æ•°: {len(merged_list)}")
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹å˜åŒ–ï¼ˆå¯èƒ½é…ç½®å·²å­˜åœ¨ï¼‰ï¼Œæ— éœ€æäº¤ã€‚"
            exit 0
          fi
          
          git add "$TARGET_FILE"
          git commit -m "chore: append new sync task configuration"
          git push
          echo "ğŸš€ æ–°é…ç½®å·²è¿½åŠ å¹¶æäº¤ã€‚"