name: Append Sync Config

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      target_file:
        description: 'ç›®æ ‡å·¥ä½œæµæ–‡ä»¶è·¯å¾„'
        required: true
        default: '.github/workflows/sync.yml'
        type: string
      new_task:
        description: 'è¦æ–°å¢çš„ä»»åŠ¡ (æ”¯æŒ JSON å¯¹è±¡æˆ–æ•°ç»„)'
        required: true
        type: string

jobs:
  append-config:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ PAT_TOKEN ä»£æ›¿é»˜è®¤çš„ GITHUB_TOKENï¼Œè·å–ä¿®æ”¹ workflow çš„æƒé™
          token: ${{ secrets.PAT_TOKEN }}

      - name: Append and Update Config
        env:
          TARGET_FILE: ${{ inputs.target_file }}
          NEW_TASK_INPUT: ${{ inputs.new_task }}
        run: |
          if [ ! -f "$TARGET_FILE" ]; then
            echo "::error:: æ–‡ä»¶ $TARGET_FILE ä¸å­˜åœ¨ï¼"
            exit 1
          fi

          echo "â–¶ æ­£åœ¨è¯»å–å¹¶åˆå¹¶é…ç½®..."

          python3 << 'EOF'
          import os
          import re
          import json
          import sys

          file_path = os.environ.get('TARGET_FILE')
          new_input = os.environ.get('NEW_TASK_INPUT')

          # 1. è¯»å–æ–‡ä»¶
          with open(file_path, 'r', encoding='utf-8') as f:
              content = f.read()

          # 2. æ­£åˆ™åŒ¹é…
          pattern = r"(# === SYNC_CONFIG_START ===\s*SYNC_TASKS=')(.*?)('\s*# === SYNC_CONFIG_END ===)"
          match = re.search(pattern, content, re.DOTALL)

          if not match:
              print("::error:: æœªæ‰¾åˆ°é…ç½®æ ‡è®°ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚")
              sys.exit(1)

          # 3. è§£ææ—§é…ç½®
          old_json_str = match.group(2).strip()
          try:
              if old_json_str:
                  current_list = json.loads(old_json_str)
              else:
                  current_list = []
          except json.JSONDecodeError:
              print(f"::error:: åŸæœ‰é…ç½® JSON æ ¼å¼é”™è¯¯: {old_json_str}")
              sys.exit(1)

          # 4. è§£ææ–°é…ç½®
          try:
              new_data = json.loads(new_input)
              if isinstance(new_data, dict):
                  new_items = [new_data]
              else:
                  new_items = new_data
          except json.JSONDecodeError:
              print(f"::error:: è¾“å…¥çš„æ–°é…ç½® JSON æ ¼å¼é”™è¯¯: {new_input}")
              sys.exit(1)

          # 5. åˆå¹¶
          merged_list = current_list + new_items

          # 6. æ ¼å¼åŒ–å¹¶ä¿æŒç¼©è¿›
          merged_json_str = json.dumps(merged_list, indent=2, ensure_ascii=False)
          
          # æ™ºèƒ½è·å–ç¼©è¿›
          prefix_line = match.group(1)
          indent_match = re.search(r"\n([ \t]*)SYNC_TASKS=", prefix_line)
          base_indent = indent_match.group(1) if indent_match else "          "

          # ç»™ JSON æ¯ä¸€è¡Œæ·»åŠ ç¼©è¿›
          json_lines = merged_json_str.split('\n')
          formatted_json = json_lines[0] + "\n" + "\n".join([base_indent + line for line in json_lines[1:]])

          # 7. æ›¿æ¢å¹¶å†™å›
          new_block = f"{match.group(1)}{formatted_json}{match.group(3)}"
          new_content = content[:match.start()] + new_block + content[match.end():]

          with open(file_path, 'w', encoding='utf-8') as f:
              f.write(new_content)

          print(f"âœ… é…ç½®å·²æ›´æ–°ã€‚åŸä»»åŠ¡æ•°: {len(current_list)}ï¼Œæ–°å¢: {len(new_items)}ï¼Œæ€»æ•°: {len(merged_list)}")
          EOF

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TARGET_FILE="${{ inputs.target_file }}"
          
          if git diff --quiet "$TARGET_FILE"; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
            exit 0
          fi
          
          git add "$TARGET_FILE"
          git commit -m "chore: append new sync task configuration"
          git push
          echo "ğŸš€ æ–°é…ç½®å·²è¿½åŠ å¹¶æäº¤ã€‚"