name: Multi-Source Sync Test

permissions:
  contents: write

on:
  workflow_dispatch: # 手动触发

jobs:
  sync_multi_sources:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4

      - name: Sync Multiple Sources
        run: |
          # ==========================================================
          # 【测试配置】已修正路径，确保真实存在
          # ==========================================================
          SYNC_TASKS='[
            {
              "source_repo": "actions/checkout",
              "source_branch": "main",
              "source_path": "README.md",
              "dest_path": "test_sync/checkout_readme.md"
            },
            {
              "source_repo": "actions/checkout",
              "source_branch": "main",
              "source_path": ".github",
              "dest_path": "test_sync/checkout_workflows_folder"
            }
          ]'
          # ==========================================================

          # 配置 Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 解析 JSON 并循环处理每个任务
          echo "$SYNC_TASKS" | jq -c '.[]' | while read -r task; do
            # 读取配置
            SRC_REPO=$(echo "$task" | jq -r '.source_repo')
            SRC_BRANCH=$(echo "$task" | jq -r '.source_branch')
            SRC_PATH=$(echo "$task" | jq -r '.source_path')
            DEST_PATH=$(echo "$task" | jq -r '.dest_path')
            
            echo "------------------------------------------------"
            echo "▶ 开始同步任务:"
            echo "  源: $SRC_REPO ($SRC_BRANCH) -> $SRC_PATH"
            echo "  目标: $DEST_PATH"
            
            # 生成唯一临时目录
            TEMP_DIR="/tmp/sync_$(echo "$SRC_REPO" | md5sum | head -c 10)"
            
            # 克隆源仓库 (稀疏检出)
            rm -rf "$TEMP_DIR"
            git clone --depth 1 --branch "$SRC_BRANCH" --filter=blob:none --sparse "https://github.com/$SRC_REPO" "$TEMP_DIR"
            
            # 设置稀疏检出路径 (支持单文件)
            pushd "$TEMP_DIR" > /dev/null
            git sparse-checkout set --no-cone "$SRC_PATH"
            popd > /dev/null
            
            # ==========================================
            # 【健壮性修复】检查源文件是否存在
            # ==========================================
            if [ ! -e "$TEMP_DIR/$SRC_PATH" ]; then
              echo "::error:: ❌ 错误：在源仓库中未找到路径 '$SRC_PATH'。请检查配置中的 source_path 是否正确（注意大小写和后缀名）。"
              exit 1
            fi

            # 准备目标目录
            mkdir -p "$DEST_PATH"
            
            # 同步文件逻辑
            if [ -d "$TEMP_DIR/$SRC_PATH" ]; then
                 # 如果是文件夹
                 echo "  类型: 文件夹同步"
                 rsync -av --delete "$TEMP_DIR/$SRC_PATH/" "$DEST_PATH/"
            else
                 # 如果是单文件
                 echo "  类型: 单文件同步"
                 PARENT_DIR=$(dirname "$DEST_PATH")
                 mkdir -p "$PARENT_DIR"
                 rsync -av --delete "$TEMP_DIR/$SRC_PATH" "$DEST_PATH"
            fi
            
            # 清理临时目录
            rm -rf "$TEMP_DIR"
          done

          echo "------------------------------------------------"
          echo "▶ 检查并提交变更..."
          
          # 只 add 配置中指定的目标路径
          echo "$SYNC_TASKS" | jq -r '.[].dest_path' | while read -r path; do
             if [ -f "$path" ] || [ -d "$path" ]; then
                git add "$path"
             fi
          done

          if ! git diff --cached --quiet; then
             echo "💾 发现变更，正在提交..."
             git commit -m "chore: sync updates from upstream sources"
             git push
             echo "✅ 同步完成并已推送。"
          else
             echo "✅ 所有文件均无变化，无需提交。"
          fi
