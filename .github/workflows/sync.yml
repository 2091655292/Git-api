name: Multi-Source Sync Test

permissions:
  contents: write

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  sync_multi_sources:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4

      - name: Sync Multiple Sources
        run: |
          # ==========================================================
          # ã€æµ‹è¯•é…ç½®ã€‘çœŸå®çš„ä»“åº“æµ‹è¯•æ•°æ®
          # ==========================================================
          SYNC_TASKS='[
            {
              "source_repo": "actions/checkout",
              "source_branch": "main",
              "source_path": "README.md",
              "dest_path": "test_sync/checkout_readme.md"
            },
            {
              "source_repo": "github/gitignore",
              "source_branch": "main",
              "source_path": "Python",
              "dest_path": "test_sync/gitignore_python_folder"
            }
          ]'
          # ==========================================================

          # é…ç½® Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # è§£æ JSON å¹¶å¾ªç¯å¤„ç†æ¯ä¸ªä»»åŠ¡
          echo "$SYNC_TASKS" | jq -c '.[]' | while read -r task; do
            # è¯»å–é…ç½®
            SRC_REPO=$(echo "$task" | jq -r '.source_repo')
            SRC_BRANCH=$(echo "$task" | jq -r '.source_branch')
            SRC_PATH=$(echo "$task" | jq -r '.source_path')
            DEST_PATH=$(echo "$task" | jq -r '.dest_path')
            
            echo "------------------------------------------------"
            echo "â–¶ å¼€å§‹åŒæ­¥ä»»åŠ¡:"
            echo "  æº: $SRC_REPO ($SRC_BRANCH) -> $SRC_PATH"
            echo "  ç›®æ ‡: $DEST_PATH"
            
            # ç”Ÿæˆå”¯ä¸€ä¸´æ—¶ç›®å½•
            TEMP_DIR="/tmp/sync_$(echo "$SRC_REPO" | md5sum | head -c 10)"
            
            # å…‹éš†æºä»“åº“ (ç¨€ç–æ£€å‡º)
            rm -rf "$TEMP_DIR"
            git clone --depth 1 --branch "$SRC_BRANCH" --filter=blob:none --sparse "https://github.com/$SRC_REPO" "$TEMP_DIR"
            
            # ==========================================
            # å…³é”®ä¿®å¤ï¼šä½¿ç”¨ --no-cone æ¨¡å¼ä»¥æ”¯æŒå•æ–‡ä»¶åŒæ­¥
            # ==========================================
            pushd "$TEMP_DIR" > /dev/null
            git sparse-checkout set --no-cone "$SRC_PATH"
            popd > /dev/null
            
            # å‡†å¤‡ç›®æ ‡ç›®å½•
            mkdir -p "$DEST_PATH"
            
            # åŒæ­¥æ–‡ä»¶é€»è¾‘
            if [ -d "$TEMP_DIR/$SRC_PATH" ]; then
                 # å¦‚æœæ˜¯æ–‡ä»¶å¤¹
                 echo "  ç±»å‹: æ–‡ä»¶å¤¹åŒæ­¥"
                 # ç¡®ä¿ç›®æ ‡æ–‡ä»¶å¤¹å­˜åœ¨
                 mkdir -p "$DEST_PATH"
                 rsync -av --delete "$TEMP_DIR/$SRC_PATH/" "$DEST_PATH/"
            else
                 # å¦‚æœæ˜¯å•æ–‡ä»¶
                 echo "  ç±»å‹: å•æ–‡ä»¶åŒæ­¥"
                 # è·å–ç›®æ ‡ç›®å½•è·¯å¾„
                 PARENT_DIR=$(dirname "$DEST_PATH")
                 mkdir -p "$PARENT_DIR"
                 rsync -av --delete "$TEMP_DIR/$SRC_PATH" "$DEST_PATH"
            fi
            
            # æ¸…ç†ä¸´æ—¶ç›®å½•
            rm -rf "$TEMP_DIR"
          done

          echo "------------------------------------------------"
          echo "â–¶ æ£€æŸ¥å¹¶æäº¤å˜æ›´..."
          
          # åª add é…ç½®ä¸­æŒ‡å®šçš„ç›®æ ‡è·¯å¾„
          echo "$SYNC_TASKS" | jq -r '.[].dest_path' | while read -r path; do
             if [ -f "$path" ] || [ -d "$path" ]; then
                git add "$path"
             fi
          done

          if ! git diff --cached --quiet; then
             echo "ğŸ’¾ å‘ç°å˜æ›´ï¼Œæ­£åœ¨æäº¤..."
             git commit -m "chore: sync updates from upstream sources"
             git push
             echo "âœ… åŒæ­¥å®Œæˆå¹¶å·²æ¨é€ã€‚"
          else
             echo "âœ… æ‰€æœ‰æ–‡ä»¶å‡æ— å˜åŒ–ï¼Œæ— éœ€æäº¤ã€‚"
          fi
